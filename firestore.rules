rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isBranchAdmin(branchId) {
       // Check if the user's branchID matches the target branchId
       // Note: This relies on Custom Claims or reading the user doc. 
       // For simplicity/performance without claims, we check if the user doc says they own it.
       // BUT, reading the user doc in rules costs a read. 
       // A common pattern is: allow write if resource.data.branchID == request.auth.token.branchID (if using claims)
       // Or: get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchID == branchId
       
       let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
       return userDoc.data.branchID == branchId && userDoc.data.role == 'branch-admin';
    }

    function isSuperAdmin() {
      // In a real app, use Custom Claims. Here we check the user doc.
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.role == 'super-admin';
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if isAuthenticated(); // Users can read profiles (e.g. for chat/reviews)
      allow write: if isOwner(userId) || isSuperAdmin(); // Users update own profile
    }

    // --- Products Collection ---
    match /products/{productId} {
      allow read: if true; // Public can view products
      
      // Create: User must be a branch admin and assigning the product to THEIR branch
      allow create: if isAuthenticated() 
                    && request.resource.data.branchID == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchID;
      
      // Update/Delete: User must own the branch this product belongs to
      allow update, delete: if isAuthenticated() 
                            && resource.data.branchID == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchID;
    }

    // --- Orders Collection ---
    match /orders/{orderId} {
      // Users can read their own orders. Branch admins can read orders for their branch.
      allow read: if isAuthenticated() && (
        resource.data.userID == request.auth.uid || 
        resource.data.branchID == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchID ||
        isSuperAdmin()
      );
      
      // Users create orders. 
      allow create: if isAuthenticated() && request.resource.data.userID == request.auth.uid;
      
      // Branch admins update status (but not other fields theoretically, but strict field level rules can be added)
      allow update: if isAuthenticated() && (
        resource.data.branchID == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchID ||
        isSuperAdmin()
      );
    }
    
    // --- Branches Collection ---
    match /branches/{branchId} {
      allow read: if true;
      allow write: if isBranchAdmin(branchId) || isSuperAdmin();
    }
    
    // --- Branch Requests ---
    match /branch_requests/{requestId} {
      allow create: if isAuthenticated();
      allow read: if isSuperAdmin() || resource.data.userID == request.auth.uid;
      allow update: if isSuperAdmin();
    }

    // --- Chats / Messages ---
    match /chats/{chatId} {
      allow read, write: if isAuthenticated() && (
        request.auth.uid in resource.data.participants || 
        request.auth.uid in request.resource.data.participants
      );
    }

    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if isAuthenticated(); // Ideally check parent chat participants
    }
    
    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
